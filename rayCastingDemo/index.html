<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ray Casting</title>
    <style>
        html, body, canvas {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <canvas id="canvas" height="100%" width="100%"></canvas>
    
</body>
<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // FPS
    const FPS = 60;
    const cycleDelay = Math.floor(1000 / FPS);
    var oldCycleTime = 0;
    var cycleCount = 0;
    var fps_rate = '...';

    // map
    const MAP_SIZE = 16;
    const MAP_SCALE = 10;
    const MAP_RANGE = MAP_SCALE * MAP_SIZE;
    const MAP_SPEED = (MAP_SCALE / 2) / 10;
    var map = [
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
    1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    ];

    // player
    var playerX = MAP_SCALE + 20;
    var playerY = MAP_SCALE + 20;
    var playerAngle = Math.PI / 3;
    var playerMoveX = 0;
    var playerMoveY = 0;
    var playerMoveAngle = 0;

    // handle key down events
    document.addEventListener('keydown', function (event) {
        var key = event.keyCode;
        switch (key) {
            case 83: playerMoveX = -1; playerMoveY = -1; break;
            case 87: playerMoveX = 1; playerMoveY = 1; break;
            case 65: playerMoveAngle = 1; break;
            case 68: playerMoveAngle = -1; break;
        }
    });
    document.addEventListener('keyup', function (event) {
        var key = event.keyCode;
        switch (key) {
            case 83: playerMoveX = 0; playerMoveY = 0; break;
            case 87: playerMoveX = 0; playerMoveY = 0; break;
            case 65: playerMoveAngle = 0; break;
            case 68: playerMoveAngle = 0; break;
        }
    });

    // screen
    const WIDTH = 300, HALF_WIDTH = 150;
    const HEIGHT = 300, HALF_HEIGHT = 150;

    // camera
    const DOUBLE_PI = Math.PI * 2;
    const FOV = Math.PI / 3;
    const HALF_FOV = FOV / 2;
    const STEP_ANGLE = FOV / WIDTH;
    
    // Game Loop
    function gameLoop() {
        // Update FPS
        cycleCount++;
        if (cycleCount >= 60) cycleCount = 0;
        var startTime = Date.now();
        var cycleTime = startTime - oldCycleTime;
        oldCycleTime = startTime;
        if (cycleCount % 60 == 0) fps_rate = Math.floor(1000 / cycleTime);

        // Resize dynamically
        canvas.width = window.innerWidth * 0.3;
        canvas.height = window.innerHeight * 0.3;

        // Update Screen
        ctx.fillStyle = 'black';
        ctx.fillRect(canvas.width / 2 - HALF_WIDTH, canvas.height / 2 - HALF_HEIGHT, WIDTH, HEIGHT);

        // update player position
        var playerOffsetX = Math.sin(playerAngle) * MAP_SPEED;
        var playerOffsetY = Math.cos(playerAngle) * MAP_SPEED;
        var mapTargetX = Math.floor(playerY / MAP_SCALE) * MAP_SIZE + Math.floor((playerX + playerOffsetX * playerMoveX) / MAP_SCALE)
        var mapTargetY = Math.floor((playerY + playerOffsetY * playerMoveY) / MAP_SCALE) * MAP_SIZE + Math.floor(playerX / MAP_SCALE)

        if (playerMoveX && map[mapTargetX] == 0) playerX += playerOffsetX * playerMoveX;
        if (playerMoveY && map[mapTargetY] == 0) playerY += playerOffsetY * playerMoveY;
        if (playerMoveAngle) playerAngle += 0.06 * playerMoveAngle;
        
        // Calculate map & player offsets
        var mapOffsetX = Math.floor(canvas.width / 2 - MAP_RANGE / 2);
        var mapOffsetY = Math.floor(canvas.height / 2 - MAP_RANGE / 2);
        var playerMapX = playerX + mapOffsetX;
        var playerMapY = playerY + mapOffsetY;

        // Draw 2d map
        for (var row = 0; row < MAP_SIZE; row++) {
            for (var col = 0; col < MAP_SIZE; col++) {
                var square = row * MAP_SIZE + col;
                if (map[square] != 0) {
                    ctx.fillStyle = '#555';
                    ctx.fillRect(mapOffsetX + col * MAP_SCALE, mapOffsetY + row * MAP_SCALE , MAP_SCALE, MAP_SCALE);
                } else {
                    ctx.fillStyle = '#aaa';
                    ctx.fillRect(mapOffsetX + col * MAP_SCALE, mapOffsetY + row * MAP_SCALE , MAP_SCALE, MAP_SCALE);
                }
            }
        }

        // Draw player on 2D map
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.arc(playerMapX, playerMapY, 2, 0, DOUBLE_PI, true);
        ctx.fill();
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(playerMapX, playerMapY);
        ctx.lineTo(playerMapX + Math.sin(playerAngle) * 5, playerMapY + Math.cos(playerAngle) * 5);
        ctx.stroke();

        // Raycasting
        var currentAngle = playerAngle;
        var rayStartX = Math.floor(playerX / MAP_SCALE) * MAP_SCALE;
        var rayStartY = Math.floor(playerY / MAP_SCALE) * MAP_SCALE;

        var currentSin = Math.sin(currentAngle); currentSin = currentSin ? currentSin : .000001;
        var currentCos = Math.cos(currentAngle); currentCos = currentCos ? currentCos : .000001;

        

        //inf loop
        setTimeout(gameLoop, cycleDelay);

        // Draw FPS
        ctx.fillStyle = 'black';
        ctx.font = '1vi Arial';
        ctx.fillText('FPS: ' + fps_rate, 5, 15);

    } window.onload = function () { gameLoop();} ;

</script>
</html>